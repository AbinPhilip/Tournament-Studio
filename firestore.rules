
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    }

    // Public read for Presenter View and other general data
    match /tournaments/{tournamentId} {
      allow read: if true;
      allow write: if request.auth != null && (request.auth.token.role == 'admin' || request.auth.token.role == 'super');
    }
    match /matches/{matchId} {
      allow read: if true;
      allow write: if request.auth != null; // More specific rules below
    }
    match /teams/{teamId} {
      allow read: if true;
      allow write: if request.auth != null && (request.auth.token.role == 'admin' || request.auth.token.role == 'super');
    }
    match /organizations/{orgId} {
      allow read: if true;
      allow write: if request.auth != null && (request.auth.token.role == 'admin' || request.auth.token.role == 'super');
    }
     match /sponsors/{sponsorId} {
      allow read: if true;
      allow write: if request.auth != null && (request.auth.token.role == 'admin' || request.auth.token.role == 'super');
    }

    // User management
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (request.auth.token.role == 'admin' || request.auth.token.role == 'super');
      allow update: if request.auth != null && (request.auth.uid == userId || request.auth.token.role == 'admin' || request.auth.token.role == 'super');
      allow delete: if request.auth != null && (request.auth.token.role == 'admin' || request.auth.token.role == 'super');
    }
    
    // Role permissions
    match /rolePermissions/{role} {
       allow read: if true; // All authenticated users can read permissions to render UI
       allow write: if request.auth != null && request.auth.token.role == 'super'; // Only super can change permissions
    }

    // Image metadata
    match /images/{imageId} {
      allow read: if true; // Public read access
      allow create: if request.auth != null; // Any authenticated user can upload
      allow delete: if request.auth != null && request.auth.uid == resource.data.uploaderId; // Only the uploader can delete
    }

    // Match scoring can be done by update, admin, super, or specific court umpires
    match /matches/{matchId} {
        // More specific write rule for matches
        allow write: if request.auth != null && 
                      (request.auth.token.role in ['update', 'admin', 'super'] || 
                      (request.auth.token.role == 'court' && request.auth.token.courtName == resource.data.courtName));
    }
  }
}
